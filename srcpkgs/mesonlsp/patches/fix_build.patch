From 8edb5af16db9d7651a88ae19d0574195a02e40b6 Mon Sep 17 00:00:00 2001
From: JCWasmx86 <JCWasmx86@t-online.de>
Date: Tue, 28 Jan 2025 05:33:33 +0100
Subject: [PATCH] Fix adding newline at the end

https://github.com/mesonbuild/vscode-meson/issues/273
---
 src/liblangserver/formatting.cpp | 2 +-
 src/liblangserver/langserver.cpp | 2 +-
 src/liblsptypes/lsptypes.hpp     | 4 +++-
 3 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/src/liblangserver/formatting.cpp b/src/liblangserver/formatting.cpp
index b061406678..10110906b9 100644
--- a/src/liblangserver/formatting.cpp
+++ b/src/liblangserver/formatting.cpp
@@ -35,7 +35,7 @@ std::string formatFile(const std::filesystem::path &path,
   struct source src = {.label = labelPath,
                        .src = strdup(toFormat.data()),
                        .len = toFormat.size(),
-                       .reopen_type = source_reopen_type_none};
+                       .type = source_type_unknown};
 #ifndef _WIN32
   char *formattedStr;
   size_t formattedSize;
diff --git a/src/liblangserver/langserver.cpp b/src/liblangserver/langserver.cpp
index d5567e7fb3..cb88aede78 100644
--- a/src/liblangserver/langserver.cpp
+++ b/src/liblangserver/langserver.cpp
@@ -102,7 +102,7 @@ void printGreeting() {
 
 std::filesystem::path writeMuonConfigFile(FormattingOptions options) {
   const auto &name =
-      std::format("muon-2-fmt-{}-{}", options.insertSpaces, options.tabSize);
+      std::format("muon-2-fmt-{}-{}-{}", options.insertSpaces, options.tabSize, options.insertFinalNewline);
   const auto &fullPath = cacheDir() / name;
   if (std::filesystem::exists(fullPath)) {
     return fullPath;
diff --git a/src/liblsptypes/lsptypes.hpp b/src/liblsptypes/lsptypes.hpp
index 4d89b59880..7ec17be323 100644
--- a/src/liblsptypes/lsptypes.hpp
+++ b/src/liblsptypes/lsptypes.hpp
@@ -1,9 +1,11 @@
 #pragma once
 #include <cassert>
 #include <cstdint>
+#include <iostream>
 #include <map>
 #include <nlohmann/json.hpp>
 #include <optional>
+#include <ostream>
 #include <string>
 #include <utility>
 #include <vector>
@@ -473,7 +475,7 @@ class FormattingOptions : public BaseObject {
   explicit FormattingOptions(nlohmann::json &jsonObj) {
     this->tabSize = jsonObj["tabSize"];
     this->insertSpaces = jsonObj["insertSpaces"];
-    this->insertFinalNewline = jsonObj.value("insertFinalNewline", false);
+    this->insertFinalNewline = jsonObj.value("insertFin alNewline", true);
   }
 };
 
