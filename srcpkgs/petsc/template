# Template file for 'petsc'
pkgname=petsc
version=3.20.5
revision=1
build_style=gnu-configure
hostmakedepends="python3 gcc-fortran openmpi python3-Cython"
makedepends="openmpi-devel libopenmpi lapack-devel python3-mpi4py python3-numpy
 python3-devel"
checkdepends="openssh"
short_desc="Portable, Extensible Toolkit for Scientific Computation"
maintainer="meator <meator.dev@gmail.com>"
license="BSD-2-Clause"
homepage="https://petsc.org/release/"
distfiles="https://web.cels.anl.gov/projects/petsc/download/release-snapshots/petsc-with-docs-${version}.tar.gz"
checksum=55b086cd75f0377708fa9463c219cad7ce933f71b7e84aa18c5bbc646de7a5a4
python_version=3
nocross="Cross version of openmpi doesn't support fortran"

do_configure() {
	# nocross is set, so this logic is unnecessary.
	#if [ "$CROSS_BUILD" ]; then
	#	SKIP_CHECKS="--with-batch"
	#fi
	#
	# XXX: More thing need to be done for cross to work:
	# 1) probably use numpy build helper
	# 2) use python build helper and make sure it's picked up
	# 3) make openmpi (mpicc, mpicxx, mpif90) be aware of cross compilation

	# Clearing the enviromnent makes configure warnings go away.
	# FFLAGS is modified because of
	# https://github.com/void-linux/void-packages/issues/49322
	env -u CC -u CXX -u FC -u CFLAGS -u CXXFLAGS -u FFLAGS -u CPP -u CPPFLAGS\
		-u LDFLAGS -u AR -u RANLIB\
		OMPI_CC="$CC" OMPI_CXX="$CXX" OMPI_FC="$FC"\
	./configure $SKIP_CHECKS ${configure_args} --with-cc=mpicc\
	--with-cxx=mpicxx --with-fc=mpif90 CFLAGS="$CFLAGS" CXXFLAGS="$CXXFLAGS"\
	CPPFLAGS="$CPPFLAGS" FFLAGS="-I$XBPS_CROSS_BASE/usr/include $FFLAGS"\
	LDFLAGS="$LDFLAGS" AR="$AR" RANLIB="$RANLIB" PETSC_ARCH="void-linux"
}

pre_build() {
	export OMPI_CC="$CC" OMPI_CXX="$CXX" OMPI_FC="$FC"
}

post_install() {
	# A subshell is used to not pollute the environment and to maintain CWD.
	(
		cd src/binding/petsc4py
		export DESTDIR="$DESTDIR" PETSC_DIR="$DESTDIR/usr/"\
			PETSC_ARCH="void-linux"
		python3 setup.py build
		python3 setup.py install --prefix=/usr --root=${DESTDIR}
		# XXX setup PETSC_ARCH in ${DESTDIR}/${py3_sitelib}/petsc4py/lib/petsc.cfg
	)
	vsed -i "${DESTDIR}/${py3_sitelib}/petsc4py/lib/petsc.cfg" -e 's|/destdir/petsc-[^/]*/usr|/usr|'
	rm ${DESTDIR}/usr/lib/petsc/conf/uninstall.py

	vmkdir usr/share/doc
	rm docs/.buildinfo
	mv docs ${DESTDIR}/usr/share/doc/petsc

	vlicense LICENSE
}

petsc-devel_package() {
	short_desc+=" - development files"
	depends="${sourcepkg}>=${version}_${revision} openmpi-devel"
	pkg_install() {
		vmove usr/include
		vmove "usr/lib/*.so"
		# XXX add the other symlink
		vmove usr/lib/pkgconfig
		vmove usr/lib/petsc
		vmove usr/share/petsc
	}
}

petsc-doc_package() {
	nostrip=yes # no executables here
	short_desc+=" - documentation"
	pkg_install() {
		vmove usr/share/doc/petsc
	}
}

python3-petsc4py_package() {
	short_desc+=" - python binding"
	depends="python3"
	pkg_install() {
		vmove "$py3_lib"
	}
}
