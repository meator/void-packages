# Template file for 'doxygen'
pkgname=doxygen
version=1.9.7
revision=1
build_style=cmake
configure_args="-Dbuild_doc=ON"
hostmakedepends="perl python3 flex texlive-ConTeXt texlive-latexextra
 texlive-dvi"
checkdepends="libxml2 texlive-BibTeX"
short_desc="Source code documentation generator tool"
maintainer="Ã‰rico Nogueira <ericonr@disroot.org>"
license="GPL-2.0-only"
homepage="http://www.doxygen.org/"
changelog="https://www.doxygen.nl/manual/changelog.html"
# This archive contains few fixes. Next update must remove .repack
distfiles="https://doxygen.nl/files/doxygen-${version}.repack.src.tar.gz"
checksum=aa9b2118578f4d277954c8584eb7228be47cdf29e8041ce4dcba21e41dfb89f3

if [ "$CROSS_BUILD" ]; then
	hostmakedepends+=" doxygen"
fi

build_options="wizard"
desc_option_wizard="build Qt5 GUI configuration tool, doxywizard"

CFLAGS="-D_LARGE_FILE_SOURCE=1 -D_FILE_OFFSET_BITS=64"
CXXFLAGS="-D_LARGE_FILE_SOURCE=1 -D_FILE_OFFSET_BITS=64"

if [ "$build_option_wizard" ]; then
	configure_args+=" -Dbuild_wizard=1"
	hostmakedepends+=" qt5-host-tools qt5-qmake"
	makedepends+=" qt5-devel"
fi

# Use the host doxygen when building documentation on cross.
do_patch() {
	if [ "$CROSS_BUILD" ]; then
		patch -Np1 < ${FILESDIR}/use-native-doxygen.patch
	fi
}

post_build() {
	ninja -C build docs
}

post_install() {
	if [ ! "$build_option_wizard" ]; then
		rm ${DESTDIR}/usr/share/man/man1/doxywizard.1
	fi

	# These manpages are generated because build_doc is ON, but we don't
	# build these programs.
	rm ${DESTDIR}/usr/share/man/man1/doxyindexer.1
	rm ${DESTDIR}/usr/share/man/man1/doxysearch.1

	mv ${DESTDIR}/usr/share/doc/packages/doxygen ${DESTDIR}/usr/share/doc/doxygen
}

doxygen-doc_package() {
	short_desc+=" - documentation"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vmove usr/share/doc/doxygen
	}
}
